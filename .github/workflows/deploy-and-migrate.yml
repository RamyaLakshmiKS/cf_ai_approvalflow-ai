name: Deploy and Apply D1 Migrations

on:
  push:
    branches:
      - main
      - add-login-ui

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Authenticate to Cloudflare (validate token)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN || secrets.CF_API_TOKEN }}
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN}" ]; then
            echo "CLOUDFLARE_API_TOKEN (or CF_API_TOKEN fallback) is not set" && exit 1
          fi
          # `wrangler whoami` will print useful context; if it fails, we still rely on CLOUDFLARE_API_TOKEN env for CLI calls
          npx wrangler whoami || true

      - name: Build and Deploy Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN || secrets.CF_API_TOKEN }}
        run: |
          npm run deploy

      - name: Apply D1 migrations to remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN || secrets.CF_API_TOKEN }}
        run: |
          # Apply migrations for the binding name configured in wrangler.jsonc (APP_DB)
          npx wrangler d1 migrations apply APP_DB
